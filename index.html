<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic Product Order Form</title>
</head>
<body>
  <h2>Order Form</h2>
  <form id="order-form">
    <label>Name: <input type="text" name="name" required /></label><br><br>

    <div id="items-container"></div>

    <button type="button" id="add-btn">➕ Add Another Product</button><br><br>
    <h3>Total: $<span id="total-cost">0.00</span></h3>
    <button type="submit">Submit Order</button>
  </form>

  <script>
    const PRODUCTS = [
      { name: "Water Bottle", price: 1.5 },
      { name: "Energy Drink", price: 2.0 },
      { name: "Lemonade", price: 1.8 },
      { name: "Coconut Water", price: 2.5 },
      { name: "Sparkling Water", price: 2.2 }
    ];
    const MAX_ITEMS = 3;

    const form = document.getElementById('order-form');
    const container = document.getElementById('items-container');
    const addBtn = document.getElementById('add-btn');
    const totalCostDisplay = document.getElementById('total-cost');

    let productCount = 0;

    function updateTotal() {
      let total = 0;
      container.querySelectorAll('.product-row').forEach(row => {
        const productName = row.querySelector('select').value;
        const qty = parseFloat(row.querySelector('input').value || 0);
        const product = PRODUCTS.find(p => p.name === productName);
        if (product) total += product.price * qty;
      });
      totalCostDisplay.textContent = total.toFixed(2);
    }

    function updateDropdowns() {
      const selected = Array.from(container.querySelectorAll('.product-dropdown'))
        .map(drop => drop.value).filter(Boolean);

      container.querySelectorAll('.product-dropdown').forEach(dropdown => {
        const current = dropdown.value;
        dropdown.innerHTML = '<option value="">Select a product</option>' +
          PRODUCTS.map(p =>
            !selected.includes(p.name) || p.name === current
              ? `<option value="${p.name}" ${p.name === current ? 'selected' : ''}>${p.name}</option>`
              : ''
          ).join('');
      });
    }

    function addProductRow() {
      if (productCount >= MAX_ITEMS) {
        alert("Maximum of 3 products allowed.");
        return;
      }

      const div = document.createElement('div');
      div.className = 'product-row';

      div.innerHTML = `
        <label>Product:
          <select class="product-dropdown" required>
            <option value="">Select a product</option>
            ${PRODUCTS.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}
          </select>
        </label>
        <label>Qty:
          <input type="number" min="1" value="1" required />
        </label>
        <button type="button" class="remove-btn">❌</button>
        <br><br>
      `;

      container.appendChild(div);
      productCount++;
      updateDropdowns();
      updateTotal();

      div.querySelector('.product-dropdown').addEventListener('change', () => {
        updateDropdowns();
        updateTotal();
      });
      div.querySelector('input').addEventListener('input', updateTotal);
      div.querySelector('.remove-btn').addEventListener('click', () => {
        container.removeChild(div);
        productCount--;
        updateDropdowns();
        updateTotal();
      });
    }

    addBtn.addEventListener('click', addProductRow);
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = form.name.value;
      const rows = container.querySelectorAll('.product-row');
      const items = Array.from(rows).map(row => ({
        product: row.querySelector('select').value,
        quantity: row.querySelector('input').value
      })).filter(item => item.product && item.quantity);

      const total = parseFloat(totalCostDisplay.textContent);

      const payload = { name, items, total };

      const response = await fetch('https://script.google.com/macros/s/AKfycbwaTDzDmyP0dJQ6uVf8TT52R1gWTSf0U1-eQHm6VMErOtwW__QaofAbs-nY-OG55bI/exec', {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      });

      if (response.ok) {
        alert('Order submitted!');
        form.reset();
        container.innerHTML = '';
        productCount = 0;
        addProductRow();
        updateTotal();
      } else {
        alert('Failed to submit order.');
      }
    });

    addProductRow();
  </script>
</body>
</html>
