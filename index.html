<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pide Tu Frugy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Bootstrap 5 CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  />
  
  <style>
    body {
      padding: 2rem;
    }
    .product-row {
      margin-bottom: 1rem;
    }
     /* ‚úÖ Hide placeholder when dropdown is opened */
    select:focus option[disabled] {
    display: none;
  }
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4">Pide tu FRUGY y Drink Cola</h1>

  <form id="order-form" novalidate>
    <div class="mb-3">
      <label for="name" class="form-label">Ingresa tu Nombre o CodigoCliente</label>
      <input type="text" class="form-control" name="name" id="name" required />
      <div class="invalid-feedback">Por favor ingresa tu Nombre o CodigoCliente.</div>
    </div>

    <div id="product-loading-msg" class="alert alert-info" role="alert">
      Cargando productos...
    </div>

    <div id="items-container"></div>

    <div class="mb-3">
      <button type="button" id="add-btn" class="btn btn-outline-primary">
        ‚ûï A√±adir Producto
      </button>
    </div>

    <div class="mb-3">
      <label for="promo" class="form-label">Codigo Promo (Optional)</label>
      <input type="text" class="form-control" name="promo" id="promo" />
    </div>

    <h4>Total: $<span id="total-cost">0.00</span></h4>

    <button type="submit" class="btn btn-success mt-2">Ordenar</button>
    
    <div id="loading" class="mt-3 d-none">
      <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
      <span class="ms-2">Processing...</span>
    </div>
  </form>
</div>

<!-- Modal for order preview -->
<div class="modal fade" id="orderPreviewModal" tabindex="-1" aria-labelledby="orderPreviewLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderPreviewLabel">Confirma tu Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="order-summary-text"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cambiar</button>
        <button type="button" class="btn btn-primary" id="confirm-submit">Comprar</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS + Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- escape HTML -->
<script>
function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  }[m]));
}

let PRODUCTS = {};
let productList = [];
const MAX_ITEMS = 3;

const form = document.getElementById('order-form');
const container = document.getElementById('items-container');
const addBtn = document.getElementById('add-btn');
const totalCostDisplay = document.getElementById('total-cost');
const loadingIndicator = document.getElementById('loading');
const previewModal = new bootstrap.Modal(document.getElementById('orderPreviewModal'));
const confirmBtn = document.getElementById('confirm-submit');
const summaryBox = document.getElementById('order-summary-text');

let productCount = 0;
let pendingOrder = {};

async function loadPrices() {
  const res = await fetch('https://script.google.com/macros/s/AKfycbzojVW0HEGO19GUIusnpwd78lx04saSydSwtaz0PKsqm8JBVFy6LV8xdAXBCNiTTjLEGw/exec');
  PRODUCTS = await res.json();
  productList = Object.keys(PRODUCTS);
  addProductRow();
  document.getElementById('product-loading-msg').remove();
}

function updateTotal() {
  let total = 0;
  container.querySelectorAll('.product-row').forEach(row => {
    const productName = row.querySelector('select').value;
    const qty = parseFloat(row.querySelector('input').value || 0);
    const price = PRODUCTS[productName]?.precio || 0;
    total += price * qty;
  });
  totalCostDisplay.textContent = total.toFixed(2);
}

function updateDropdowns() {
  const selected = Array.from(container.querySelectorAll('.product-dropdown'))
    .map(drop => drop.value).filter(Boolean);

  container.querySelectorAll('.product-dropdown').forEach(dropdown => {
    const current = dropdown.value;
    const isEmpty = !current || !productList.includes(current);
    dropdown.innerHTML =
      `<option value="" disabled selected>Selecciona un producto</option>` +
      productList.map(p =>
        !selected.includes(p) || p === current
          ? `<option value="${p}" ${p === current ? 'selected' : ''}>${PRODUCTS[p].descripcion} ($${PRODUCTS[p].precio.toFixed(2)})</option>`
          : ''
      ).join('');
  });

}

function addProductRow() {
  if (productCount >= MAX_ITEMS) {
    alert("Maximum of 3 products allowed.");
    return;
  }

  const div = document.createElement('div');
  div.className = 'product-row row align-items-end';

  div.innerHTML = `
    <div class="col-md-6 mb-2">
      <label class="form-label">Cual quereis?</label>
      <select class="form-select product-dropdown" required>
        <option value="">Selecciona un producto</option>
        ${productList.map(p => `<option value="${p}">${PRODUCTS[p].descripcion} ($${PRODUCTS[p].precio.toFixed(2)})</option>`).join('')}
      </select>
    </div>
    <div class="col-md-3 mb-2">
      <label class="form-label">Cuantas Cajas?</label>
      <input type="number" class="form-control" min="1" value="1" required />
    </div>
    <div class="col-md-3 mb-2">
      <button type="button" class="btn btn-outline-danger remove-btn w-100">‚ùå Remover</button>
    </div>
  `;

  container.appendChild(div);
  productCount++;
  updateDropdowns();
  updateTotal();

  div.querySelector('select').addEventListener('change', () => {
    updateDropdowns();
    updateTotal();
  });
  div.querySelector('input').addEventListener('input', updateTotal);
  div.querySelector('.remove-btn').addEventListener('click', () => {
    container.removeChild(div);
    productCount--;
    updateDropdowns();
    updateTotal();
  });
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const name = form.name.value.trim();
  if (!name) return alert('Porfavor ingresa tu nombre.');

  const promo = form.promo.value.trim();

  const rows = container.querySelectorAll('.product-row');
  const items = Array.from(rows).map(row => ({
    codigoProducto: row.querySelector('select').value,
    cantidad: parseInt(row.querySelector('input').value),
    promo: promo
  })).filter(item => item.product && item.quantity);

  loadingIndicator.classList.remove('d-none');

  try {
    const preview = await fetch('https://script.google.com/macros/s/AKfycbzojVW0HEGO19GUIusnpwd78lx04saSydSwtaz0PKsqm8JBVFy6LV8xdAXBCNiTTjLEGw/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ 
        cliente: name, 
        telefono: "0000000000",
        promo, 
        items,
        preview: true,
        save: false
      })
    });
    const result = await preview.json();
    console.log("üîÅ Preview response", result);
    //pendingOrder = { name, items, total: result.total };
    const total = result.total || result.resumen?.total || 0;
    pendingOrder = { name, promo, items, total };

  summaryBox.innerHTML = `
    <ul class="list-group mb-3">
      ${items.map(i => `
        <li class="list-group-item">
          ${escapeHTML(i.quantity.toString())} √ó ${escapeHTML(PRODUCTS[i.product].descripcion)} ($${PRODUCTS[i.product].precio.toFixed(2)})
        </li>`).join('')}
    </ul>
    ${promo ? `<p><strong>Codigo Promo:</strong> ${escapeHTML(promo)}</p>` : ''}
    <p><strong>Cliente:</strong> ${escapeHTML(name)}</p>
    <p><strong>Total:</strong> $${total.toFixed(2)}</p>
  `;

    previewModal.show();
  } catch (err) {
    alert("‚ùå Failed to preview order.");
    console.error(err);
  } finally {
    loadingIndicator.classList.add('d-none');
  }
});

confirmBtn.addEventListener('click', async () => {
  confirmBtn.disabled = true;
  loadingIndicator.classList.remove('d-none');

  try {
    const response = await fetch('https://script.google.com/macros/s/AKfycbzojVW0HEGO19GUIusnpwd78lx04saSydSwtaz0PKsqm8JBVFy6LV8xdAXBCNiTTjLEGw/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ ...pendingOrder, save: true })
    });

    if (response.ok) {
      alert("‚úÖ Order submitted!");
      form.reset();
      container.innerHTML = '';
      productCount = 0;
      addProductRow();
      updateTotal();
      previewModal.hide();
    } else {
      alert("‚ùå Failed to submit order.");
    }
  } catch (err) {
    alert("‚ùå Submission error.");
    console.error(err);
  } finally {
    confirmBtn.disabled = false;
    loadingIndicator.classList.add('d-none');
  }
});

addBtn.addEventListener('click', addProductRow);
loadPrices();
</script>
</body>
</html>


















