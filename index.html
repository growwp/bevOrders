<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pide Tu Frugy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Bootstrap 5 CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  />
  
  <style>
    body {
      padding: 2rem;
    }
    .product-row {
      margin-bottom: 1rem;
    }
     /* ‚úÖ Hide placeholder when dropdown is opened */
    select:focus option[disabled] {
    display: none;
  }
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4">Pide tu FRUGY y Drink Cola</h1>

  <!-- ‚úÖ ADDED: LOGIN SECTION -->
  <div id="login-section">
    <div class="mb-3">
      <label for="codigoCliente" class="form-label">C√≥digo de Cliente</label>
      <input type="text" class="form-control" id="codigoCliente" required />
    </div>
    <div class="mb-3">
      <label for="telefonoCliente" class="form-label">Tel√©fono</label>
      <input type="text" class="form-control" id="telefonoCliente" required />
    </div>
    <button id="loginBtn" class="btn btn-primary">Ingresar</button>
  </div>
  
  <!-- ‚úÖ WRAPPED EXISTING FORM IN HIDDEN SECTION -->
  <div id="order-form-section" style="display: none;">
    <form id="order-form" novalidate>
      <!-- ‚úÖ MODIFIED: This input will now be auto-filled -->
      <div class="mb-3">
        <label for="name" class="form-label">Cliente</label>
        <input type="text" class="form-control" name="name" id="name" readonly />       
      </div>

      <!-- ‚úÖ ADDED: Phone field to prefill -->
      <div class="mb-3">
        <label for="telefono" class="form-label">Tel√©fono</label>
        <input type="text" class="form-control" name="telefono" id="telefono" readonly />
      </div>

      <!-- ‚úÖ ADDED: Summary of address and sales rep -->
      <div class="mb-3">
        <p class="form-text" id="clienteResumen"></p>
      </div>      
  
      <div id="product-loading-msg" class="alert alert-info" role="alert">
        Cargando productos...
      </div>

      <div class="mb-3">
        <h5>Selecciona tus Productos</h5>
        <div id="product-grid" class="row g-3">
          <!-- Tiles will be injected here -->
        </div>
      </div>

      <div class="mb-3">
        <h5>Tu Pedido</h5>
        <ul id="order-summary" class="list-group"></ul>
      </div>

  
      <div class="mb-3">
        <label for="promo" class="form-label">Codigo Promo (Optional)</label>
        <input type="text" class="form-control" name="promo" id="promo" />
      </div>
  
      <h4>Total: $<span id="total-cost">0.00</span></h4>
  
      <button type="submit" class="btn btn-success mt-2">Ordenar</button>
      
      <div id="loading" class="mt-3 d-none">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <span class="ms-2">Processing...</span>
      </div>
    </form>
  </div>
</div>

<!-- Modal for order preview -->
<div class="modal fade" id="orderPreviewModal" tabindex="-1" aria-labelledby="orderPreviewLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderPreviewLabel">Confirma tu Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="order-summary-text"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cambiar</button>
        <button type="button" class="btn btn-primary" id="confirm-submit">Comprar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for tiles -->
<div class="modal fade" id="presentationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Selecciona Presentaciones</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div><strong id="modal-product-name"></strong></div>
        <div class="row mt-3">
          <div class="col-6">1LT</div>
          <div class="col-6"><input type="number" class="form-control" id="qty-1lt" min="0" value="0"></div>
        </div>
        <div class="row mt-2">
          <div class="col-6">500ML</div>
          <div class="col-6"><input type="number" class="form-control" id="qty-500ml" min="0" value="0"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" id="confirm-quantity-btn">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS + Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- escape HTML -->
<script>
function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  }[m]));
}

//Order reset form
function resetOrderForm() {

  pendingOrder = {};
  form.promo.value = '';
  //Products Dropdown
  //addProductRow();
  //updateTotal();
  previewModal.hide();
}

let PRODUCTS = {};
let productList = [];
let currentClient = null; //Will hold authenticated client info
const MAX_ITEMS = 3;

const form = document.getElementById('order-form');
//dropdown logic
//const addBtn = document.getElementById('add-btn');
const totalCostDisplay = document.getElementById('total-cost');
const loadingIndicator = document.getElementById('loading');
const previewModal = new bootstrap.Modal(document.getElementById('orderPreviewModal'));
const confirmBtn = document.getElementById('confirm-submit');
const summaryBox = document.getElementById('order-summary-text');
  
let pendingOrder = {};

async function loadPrices() {
  const res = await fetch('https://script.google.com/macros/s/AKfycbzojVW0HEGO19GUIusnpwd78lx04saSydSwtaz0PKsqm8JBVFy6LV8xdAXBCNiTTjLEGw/exec');
  PRODUCTS = await res.json();
  productList = Object.keys(PRODUCTS);
  //Dropdown
  //addProductRow();
  //Tiles
  renderProductTiles();
  document.getElementById('product-loading-msg').remove();
}

//Render Tiles
const productGrid = document.getElementById('product-grid');
const presentationModal = new bootstrap.Modal(document.getElementById('presentationModal'));
let selectedProducts = {}; // { P1: { '1LT': qty, '500ML': qty } }

function renderProductTiles() {
  productGrid.innerHTML = '';
  productList.forEach(code => {
    const tile = document.createElement('div');
    tile.className = 'col-4';
    tile.innerHTML = `
      <div class="card product-tile ${selectedProducts[code] ? 'border-primary' : ''}" data-code="${code}" style="cursor:pointer;">
        <div class="card-body text-center">
          <h5 class="card-title">${PRODUCTS[code].descripcion}</h5>
        </div>
      </div>
    `;
    tile.querySelector('.product-tile').addEventListener('click', () => openPresentationModal(code));
    productGrid.appendChild(tile);
  });
}

let currentProductCode = null;

function openPresentationModal(code) {
  currentProductCode = code;
  document.getElementById('modal-product-name').textContent = PRODUCTS[code].descripcion;
  document.getElementById('qty-1lt').value = selectedProducts[code]?.['1LT'] || 0;
  document.getElementById('qty-500ml').value = selectedProducts[code]?.['500ML'] || 0;
  presentationModal.show();
}

document.getElementById('confirm-quantity-btn').addEventListener('click', () => {
  const q1 = parseInt(document.getElementById('qty-1lt').value || 0);
  const q2 = parseInt(document.getElementById('qty-500ml').value || 0);

  if (q1 === 0 && q2 === 0) {
    delete selectedProducts[currentProductCode];
  } else {
    selectedProducts[currentProductCode] = {
      '1LT': q1,
      '500ML': q2
    };
  }

  updateOrderSummary();
  renderProductTiles(); // Re-render to update tile border
  presentationModal.hide();
});

function updateOrderSummary() {
  const orderSummary = document.getElementById('order-summary');
  orderSummary.innerHTML = '';

  Object.entries(selectedProducts).forEach(([code, qtys]) => {
    const item = PRODUCTS[code];
    if (qtys['1LT'] > 0) {
      orderSummary.innerHTML += `<li class="list-group-item">
        ${qtys['1LT']} √ó ${item.descripcion} (1LT) - $${(item.precio * qtys['1LT']).toFixed(2)}
      </li>`;
    }
    if (qtys['500ML'] > 0) {
      orderSummary.innerHTML += `<li class="list-group-item">
        ${qtys['500ML']} √ó ${item.descripcion} (500ML) - $${(item.precio * qtys['500ML']).toFixed(2)}
      </li>`;
    }
  });

  // Optional: update total cost
  let total = 0;
  for (let code in selectedProducts) {
    const item = PRODUCTS[code];
    total += item.precio * (selectedProducts[code]['1LT'] || 0);
    total += item.precio * (selectedProducts[code]['500ML'] || 0);
  }
  document.getElementById('total-cost').textContent = total.toFixed(2);
}

//Form SUBMIT
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const name = form.name.value.trim();
  const telefono = form.telefono.value.trim();
  if (!name || !telefono) return alert('Faltan datos del cliente.');

  const promo = form.promo.value.trim();

  const items = [];

  for (let code in selectedProducts) {
    const entry = selectedProducts[code];
    if (entry['1LT'] > 0) {
      items.push({ codigoProducto: code, cantidad: entry['1LT'], presentacion: '1LT' });
    }
    if (entry['500ML'] > 0) {
      items.push({ codigoProducto: code, cantidad: entry['500ML'], presentacion: '500ML' });
    }
  }  

  // ‚úÖ ADD THIS CHECK HERE
  if (items.length === 0) {
    alert("Debes seleccionar al menos un producto.");
    return;
  }

  // ‚úÖ Check for duplicate products
  const itemKeys = items.map(i => `${i.codigoProducto}-${i.presentacion}`);
  const hasDuplicates = new Set(itemKeys).size !== itemKeys.length;

  if (hasDuplicates) {
    alert("No puedes seleccionar el mismo producto m√°s de una vez.");
    return;
  }

  loadingIndicator.classList.remove('d-none');

  //Preview Call
  try {
    const preview = await fetch('https://script.google.com/macros/s/AKfycbzojVW0HEGO19GUIusnpwd78lx04saSydSwtaz0PKsqm8JBVFy6LV8xdAXBCNiTTjLEGw/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ 
        codigoCliente: currentClient?.codigoCliente || '',
        nombre: currentClient?.nombre || '', 
        telefono,
        codigoVendedor: currentClient?.codigoVendedor || '',
        promo, 
        items,
        preview: true,
        save: false
      })
    });
    const result = await preview.json();
    console.log("üîÅ Preview response", result);
    //pendingOrder = { name, items, total: result.total };
    const total = result.total || result.resumen?.total || 0;
    pendingOrder = { 
      codigoCliente: currentClient.codigoCliente,
      nombre: currentClient.nombre, 
      telefono: currentClient.telefono,
      codigoVendedor: currentClient.codigoVendedor,
      promo, 
      items: result.articulos,
      token: result.token,
      total: result.total 
    };

  summaryBox.innerHTML = `
    <ul class="list-group mb-3">
      ${items.map(i => `
        <li class="list-group-item">
          ${escapeHTML(i.cantidad.toString())} √ó ${escapeHTML(PRODUCTS[i.codigoProducto].descripcion)} ($${PRODUCTS[i.codigoProducto].precio.toFixed(2)})
        </li>`).join('')}
    </ul>
    ${promo ? `<p><strong>Codigo Promo:</strong> ${escapeHTML(promo)}</p>` : ''}
    <p><strong>Cliente:</strong> ${escapeHTML(currentClient?.nombre || name)}</p>
    <p><strong>Total:</strong> $${total.toFixed(2)}</p>
  `;

    previewModal.show();
  } catch (err) {
    alert("‚ùå Failed to preview order.");
    console.error(err);
  } finally {
    loadingIndicator.classList.add('d-none');
  }
});

confirmBtn.addEventListener('click', async () => {
  confirmBtn.disabled = true;
  loadingIndicator.classList.remove('d-none');

  try {
    const finalPayload = { ...pendingOrder, save: true };
    console.log("üöÄ Submitting final order:", finalPayload);
    const response = await fetch('https://script.google.com/macros/s/AKfycbzojVW0HEGO19GUIusnpwd78lx04saSydSwtaz0PKsqm8JBVFy6LV8xdAXBCNiTTjLEGw/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(finalPayload)
    });

    if (response.ok) {
      const data = await response.json();
      alert(`‚úÖ Su Orden (${data.numeroOrden}) fue recibida`);
      resetOrderForm();
    } else {
      alert("‚ùå Failed to submit order.");
    }
  } catch (err) {
    alert("‚ùå Submission error.");
    console.error(err);
  } finally {
    confirmBtn.disabled = false;
    loadingIndicator.classList.add('d-none');
  }
});
//Dropdown Logic
//addBtn.addEventListener('click', addProductRow);

// Prefill login fields from URL parameters if present
const params = new URLSearchParams(window.location.search);
if (params.has('cliente')) {
  document.getElementById('codigoCliente').value = params.get('cliente');
}
if (params.has('telefono')) {
  document.getElementById('telefonoCliente').value = params.get('telefono');
}

  
// ‚úÖ LOGIN HANDLER
document.getElementById('loginBtn').addEventListener('click', async () => {
  const codigoCliente = document.getElementById('codigoCliente').value.trim();
  const telefono = document.getElementById('telefonoCliente').value.trim();

  if (!codigoCliente || !telefono) {
    alert('Por favor completa ambos campos.');
    return;
  }

  try {
    const response = await fetch('https://script.google.com/macros/s/AKfycbzojVW0HEGO19GUIusnpwd78lx04saSydSwtaz0PKsqm8JBVFy6LV8xdAXBCNiTTjLEGw/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain'  },
      body: JSON.stringify({
        login: true,
        codigoCliente: codigoCliente,
        telefono: telefono
      })
    });

    const result = await response.json();
    if (result.success) {
      currentClient = {
      ...result.client,
      codigoCliente // pulled from the login input field above
      };

      // ‚úÖ Prefill form with client info
      document.getElementById('name').value = currentClient.nombre;
      document.getElementById('telefono').value = currentClient.telefono;
      document.getElementById('clienteResumen').innerText =
        `${currentClient.direccion} | Representante: ${currentClient.nombreVendedor} | C√≥digo: ${currentClient.codigoCliente}`;

      // ‚úÖ Show order form and hide login
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('order-form-section').style.display = 'block';

      //Call load prices
      loadPrices();
    } else {
      console.error("‚ùå Backend responded but login failed:", result);
      alert("‚ùå Cliente no encontrado. Verifica los datos.");
    }
  } catch (err) {
    console.error("Error durante login:", err);
    alert("‚ùå Error de conexi√≥n al servidor.");
  }
});
</script>
</body>
</html>






























