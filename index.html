<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic Product Order Form</title>
</head>
<body>
  <h2>Order Form</h2>
  <form id="order-form">
    <label>Name: <input type="text" name="name" required /></label><br><br>

    <div id="items-container"></div>

    <button type="button" id="add-btn">➕ Add Another Product</button><br><br>
    <h3>Total: $<span id="total-cost">0.00</span></h3>
    <button type="submit">Submit Order</button>
  </form>

  <script>
  let PRODUCTS = {}; // price list from backend
  let productList = []; // list of names only
  const MAX_ITEMS = 3;

  const form = document.getElementById('order-form');
  const container = document.getElementById('items-container');
  const addBtn = document.getElementById('add-btn');
  const totalCostDisplay = document.getElementById('total-cost');

  let productCount = 0;

  async function loadPrices() {
    const res = await fetch('https://script.google.com/macros/s/AKfycbydUeZb5XTuqaRO8nO9Q1MVSOCi_jXDVK6Rmp3P4rRxLeNF4qtUrtLdjUbwehvdmZwR/exec');
    PRODUCTS = await res.json();
    productList = Object.keys(PRODUCTS);
    addProductRow();
  }

  function updateTotal() {
    let total = 0;
    container.querySelectorAll('.product-row').forEach(row => {
      const productName = row.querySelector('select').value;
      const qty = parseFloat(row.querySelector('input').value || 0);
      const price = PRODUCTS[productName] || 0;
      total += price * qty;
    });
    totalCostDisplay.textContent = total.toFixed(2);
  }

  function updateDropdowns() {
    const selected = Array.from(container.querySelectorAll('.product-dropdown'))
      .map(drop => drop.value).filter(Boolean);

    container.querySelectorAll('.product-dropdown').forEach(dropdown => {
      const current = dropdown.value;
      dropdown.innerHTML = '<option value="">Select a product</option>' +
        productList.map(p =>
          !selected.includes(p) || p === current
            ? `<option value="${p}" ${p === current ? 'selected' : ''}>${p}</option>`
            : ''
        ).join('');
    });
  }

  function addProductRow() {
    if (productCount >= MAX_ITEMS) {
      alert("Maximum of 3 products allowed.");
      return;
    }

    const div = document.createElement('div');
    div.className = 'product-row';

    div.innerHTML = `
      <label>Product:
        <select class="product-dropdown" required>
          <option value="">Select a product</option>
          ${productList.map(p => `<option value="${p}">${p}</option>`).join('')}
        </select>
      </label>
      <label>Qty:
        <input type="number" min="1" value="1" required />
      </label>
      <button type="button" class="remove-btn">❌</button>
      <br><br>
    `;

    container.appendChild(div);
    productCount++;
    updateDropdowns();
    updateTotal();

    div.querySelector('select').addEventListener('change', () => {
      updateDropdowns();
      updateTotal();
    });
    div.querySelector('input').addEventListener('input', updateTotal);
    div.querySelector('.remove-btn').addEventListener('click', () => {
      container.removeChild(div);
      productCount--;
      updateDropdowns();
      updateTotal();
    });
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = form.name.value;
    const rows = container.querySelectorAll('.product-row');
    const items = Array.from(rows).map(row => ({
      product: row.querySelector('select').value,
      quantity: parseInt(row.querySelector('input').value)
    })).filter(item => item.product && item.quantity);

    // Preview first: send to backend to get calculated total
    const preview = await fetch('https://script.google.com/macros/s/AKfycbydUeZb5XTuqaRO8nO9Q1MVSOCi_jXDVK6Rmp3P4rRxLeNF4qtUrtLdjUbwehvdmZwR/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ name, items })
    });
    const result = await preview.json();

    const summary = items.map(i =>
      `${i.quantity} × ${i.product} ($${PRODUCTS[i.product].toFixed(2)})`
    ).join('\n');

    const confirmOrder = confirm(`Review your order:\n\n${summary}\n\nTotal: $${result.total.toFixed(2)}\n\nPlace order?`);

    if (!confirmOrder) return;

    // Re-submit (or remove this if backend already saves on first POST)
    const response = await fetch('https://script.google.com/macros/s/AKfycbydUeZb5XTuqaRO8nO9Q1MVSOCi_jXDVK6Rmp3P4rRxLeNF4qtUrtLdjUbwehvdmZwR/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ name, items })
    });

    if (response.ok) {
      alert('Order submitted!');
      form.reset();
      container.innerHTML = '';
      productCount = 0;
      addProductRow();
      updateTotal();
    } else {
      alert('Failed to submit order.');
    }
  });

  loadPrices(); // kick off
  addBtn.addEventListener('click', addProductRow);
</script>
</body>
</html>
